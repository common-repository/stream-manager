jQuery(function(e){var t={$stream:e(".sm-posts"),$queue:e(".sm-alert"),$search:e(".sm-search"),$results:e(".sm-results"),$form:e("form#post"),init:function(){e(document).on("heartbeat-tick.sm",e.proxy(this.on_heartbeat,this)),this.$stream.on("click",".pin-unpin",e.proxy(this.on_stub_pin,this)).on("dblclick",".stub",e.proxy(this.on_stub_pin,this)).on("click",".remove",e.proxy(this.on_stub_remove,this)).sortable({start:e.proxy(this.on_sortable_start,this),stop:e.proxy(this.on_sortable_stop,this),change:e.proxy(this.on_sortable_change,this),revert:150,axis:"y"}),e(".reload-stream").on("click",e.proxy(this.on_stream_reload,this)),e(document).on("sm/stream_update",e.proxy(this.on_stream_update,this)),this.$queue.on("click",e.proxy(this.on_apply_queue,this)),this.$form.on("submit.sm",e.proxy(this.on_form_submit,this)),this.$search.on({input:e.proxy(this.on_search_input,this),keydown:e.proxy(this.on_search_keydown,this),focus:e.proxy(this.on_show_results,this)}),this.$results.on({mouseover:e.proxy(this.on_result_hover,this),"click sm/select":e.proxy(this.on_result_select,this)},".sm-result"),e("body").on("mousedown",e.proxy(this.on_hide_results,this))},on_heartbeat:function(e,t){var i=this,s=this.$stream.attr("data-ids").split(",");back=t.sm_ids.split(","),_.each(_.difference(back,s),function(e){i.add_to_queue("insert",e,_.indexOf(back,e))}),_.each(_.difference(s,back),function(e){i.add_to_queue("remove",e)});var n=this.$stream.attr("data-pinned").split(","),o=t.sm_pinned.split(",");_.each(_.difference(n,o),function(e){i.add_to_queue("remove",e)}),this.$stream.prop({"data-ids":t.sm_ids,"data-pinned":t.sm_pinned})},on_stub_pin:function(t){t.preventDefault();var i=e(t.target);i.is(".stub")||(i=i.closest(".stub")),i.hasClass("zone")||(i.hasClass("pinned")?(i.removeClass("pinned"),i.find(".sm-pin-checkbox").prop("checked",!1),i.find(".pin-unpin").prop("title","Pin this post")):(i.addClass("pinned"),i.find(".sm-pin-checkbox").prop("checked",!0),i.find(".pin-unpin").prop("title","Unpin this post").addClass("animating").one("webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend",function(){e(this).removeClass("animating")})))},on_stub_remove:function(t){t.preventDefault();var i=e(t.target).closest(".stub"),s=this;if(i.hasClass("zone"))return i.remove(),void e(document).trigger("sm/zone_update");i.hasClass("removed")||(i.addClass("removed"),setTimeout(function(){s.remove_single(i.attr("data-id"))},500))},on_sortable_start:function(t,i){e(document).trigger("sm/sortable_start",i.item),e(i.placeholder).height(e(i.item).height()),i.item.hasClass("pinned")?i.item.hasClass("zone")?this.pinned_inventory=[]:this.inventory_pinned("zone"):this.inventory_pinned()},on_sortable_stop:function(t,i){i.item.hasClass("zone")&&e(document).trigger("sm/zone_update")},on_sortable_change:function(e,t){this.remove_pinned(),this.insert_pinned()},on_stream_reload:function(t){t.preventDefault();var i=this;this.insert_queue=[],this.remove_queue=[],e(document).trigger("sm/stream_update"),e(document).off("heartbeat-tick.sm");var s=[];e("#categorychecklist input:checked").each(function(){s.push(e(this).val())});var n=[];e(".stub.pinned").each(function(){n.push(e(this).attr("data-id"))});var o={action:"sm_reload",stream_id:e("#post_ID").val(),taxonomies:{category:s,post_tag:e("#tax-input-post_tag").val()},exclude:n};e.post(ajaxurl,o,function(t){t=JSON.parse(t),t.status&&"error"!=t.status&&(i.inventory_pinned(),i.remove_pinned(),i.$stream.empty(),e(t.data).each(function(){i.$stream.append(this)}),i.insert_pinned())})},on_stream_update:function(e){var t=this.insert_queue,i=this.remove_queue;if(t.length+i.length>0){this.$queue.show();var s=['<span class="dashicons dashicons-plus"></span> '];1==t.length?s.push("There is 1 new post. "):t.length>1&&s.push("There are "+t.length+" new posts. "),1==i.length?s.push("There is 1 removed post."):i.length>1&&s.push("There are "+i.length+" removed posts."),this.$queue.html(s.join("")),this.allow_submit=!1}else this.$queue.hide(),this.allow_submit=!0},on_apply_queue:function(e){this.apply_queues(),this.allow_submit=!0},on_form_submit:function(e){this.submit_flag=!this.submit_flag,(this.submit_flag||this.allow_submit)&&(this.allow_submit||(window.confirm("New posts have been published or removed since you began editing the stream. \n\nPress Cancel to go back, or OK to save the stream without them.")?this.allow_submit=!0:e.preventDefault()))},insert_queue:[],remove_queue:[],add_to_queue:function(t,i,s){if("insert"==t){if(this.post_exists(i)||-1!==this.is_in_queue("insert",i))return;this.insert_queue.push({id:i,position:s})}else if("remove"==t){if(!this.post_exists(i)||-1!==this.is_in_queue("remove",i))return;this.remove_queue.push({id:i})}e(document).trigger("sm/stream_update")},remove_from_queue:function(t,s){var n=t+"_queue";for(i in this[n])this[n][i].id==s&&this[n].splice(i,1);e(document).trigger("sm/stream_update")},is_in_queue:function(e,t){var s=e+"_queue";for(i in this[s])if(this[s][i].id==t)return i;return-1},apply_insert:function(t,i){var s=t||this.insert_queue;if(!(s.length<1)){var n=this;e.post(ajaxurl,{action:"sm_request",queue:s},function(t){t=JSON.parse(t),t.status&&"error"==t.status||(n.ui_insert(t.data,i),e(document).trigger("sm/stream_update"))})}},apply_remove:function(t){var i=t||this.remove_queue;i.length<1||(this.ui_remove(i),e(document).trigger("sm/stream_update"))},apply_queues:function(){this.apply_remove(),this.apply_insert(null,!0)},ui_insert:function(e,t){if(e){this.inventory_pinned(),this.remove_pinned();for(id in e)e[id].object&&this.inject(e[id].position,e[id].object,t),this.remove_from_queue("insert",id);this.insert_pinned()}},ui_remove:function(e){if(e){this.inventory_pinned(),this.remove_pinned(),this.delete_pinned(e);for(i in e){var t=e[i].id;this.$stream.find("#post-"+t).remove(),this.remove_from_queue("remove",t)}this.insert_pinned()}},insert_single:function(e,t){this.post_exists(e)||this.apply_insert([{id:e,position:t}],!0)},remove_single:function(e){this.post_exists(e)&&this.apply_remove([{id:e}])},inject:function(t,i,s){if(i=e(i),0==t)this.$stream.prepend(i);else{var n=this.$stream.find(".stub:nth-child("+t+")");n.length?n.after(i):this.$stream.append(i)}s&&(i.addClass("inserted"),setTimeout(function(){i.removeClass("inserted")},2e3))},find_post:function(e){return this.$stream.find("#post-"+e)},post_exists:function(e){return this.find_post(e).length},pinned_inventory:[],inventory_pinned:function(t){t||(t="pinned");var i=this;this.pinned_inventory=[],this.$stream.find(".stub").each(function(s){e(this).hasClass(t)&&i.pinned_inventory.push({id:e(this).attr("data-id"),obj:this,position:s})})},remove_pinned:function(){for(i in this.pinned_inventory)this.pinned_inventory[i].obj.remove()},delete_pinned:function(e){for(i in this.pinned_inventory){var t=this.pinned_inventory[i].id;for(j in e)e[j].id==t&&(this.remove_from_queue("remove",t),this.pinned_inventory.splice(i,1))}},insert_pinned:function(){for(i in this.pinned_inventory)this.inject(this.pinned_inventory[i].position,this.pinned_inventory[i].obj)},search_query:"",search_timer:null,allow_submit:!0,submit_flag:!0,on_search_input:function(t){var s=this;clearTimeout(this.search_timer),this.search_timer=setTimeout(function(){if(e(t.target).val()!==s.search_query)if(s.search_query=e(t.target).val(),s.search_query.length>2){var n={action:"sm_search",query:s.search_query,stream_id:e("#post_ID").val()};e.post(ajaxurl,n,function(e){var t=JSON.parse(e);s.$results.empty(),s.$results.show();for(i in t.data){var n=t.data[i];s.$results.append(["<li>",'<a class="sm-result" href="#" data-id="'+n.id+'">',n.title,' <span class="sm-result-date" title="'+n.date+'">',n.human_date+" ago",s.post_exists(n.id)?" - Already in stream":"","</span>","</a>","</li>"].join("")),s.$results.find("li:nth-child(1) .sm-result").addClass("active")}})}else s.$results.empty(),s.$results.hide()},200)},on_search_keydown:function(e){if(38==e.keyCode){e.preventDefault(),this.$results.show();var t=this.$results.find(".active"),i=t.parent().prev().find(".sm-result");if(!i.length)return;t.removeClass("active"),i.addClass("active")}else if(40==e.keyCode){e.preventDefault(),this.$results.show();var t=this.$results.find(".active"),s=t.parent().next().find(".sm-result");if(!s.length)return;t.removeClass("active"),s.addClass("active")}else if(13==e.keyCode){if(e.preventDefault(),!this.$results.is(":visible"))return;this.$results.find(".active").trigger("sm/select")}},on_show_results:function(e){this.$results.is(":empty")||this.$results.show()},on_result_hover:function(t){e(t.currentTarget).hasClass("active")||(this.$results.find(".active").removeClass("active"),e(t.currentTarget).addClass("active"))},on_result_select:function(t){t.preventDefault();var i=e(t.currentTarget).attr("data-id"),s=this.find_post(i);if(s&&s.length){if(s.hasClass("pinned"))return setTimeout(function(){alert("This post is already pinned in the stream. To move it, please unpin it first.")},0),!1;this.remove_single(i)}this.insert_single(i,0),this.$results.hide()},on_hide_results:function(t){e(t.target).closest(".sm-search-container").length||this.$results.hide()}};t.layouts={data:{},init:function(){this.$data_field=e(".layouts-data"),this.$container=e("#stream_box_zones"),this.data=JSON.parse(this.$data_field.val()),e(document).on("sm/zone_update",e.proxy(this.on_zone_update,this)),this.$container.find(".add-zone-input").on("keydown",e.proxy(this.on_add_keydown,this)),this.$container.find(".add-zone-button").on("click",e.proxy(this.on_click_add_button,this)),t.$stream.on({input:e.proxy(this.on_zone_update,this),keydown:this.on_zone_keydown},".zone .zone-header")},on_toggle_add:function(t){t.preventDefault(),e(this).siblings(".add-zone-container").toggle()},on_zone_update:function(){var s=this,n=this.data.active;this.data.layouts[n].zones=[],t.$stream.find(".zone").each(function(t,i){s.data.layouts[n].zones.push({position:e(this).index(),title:e(this).find(".zone-header").val()})});var o=this.$container.find(".active-layout");o.empty();for(i in this.data.layouts)o.append(['<option value="'+i+'"'+(i==this.data.active?" selected":"")+">",this.data.layouts[i].name,"</option>"].join(""));this.$data_field.val(JSON.stringify(this.data))},on_zone_keydown:function(e){"13"==e.keyCode&&(e.preventDefault(),this.blur())},on_click_add_button:function(t){t.preventDefault();var i=e(t.currentTarget).siblings(".layouts-input");this.insert_zones([{position:0,title:i.val()}]),i.val("")},on_add_keydown:function(t){"13"==t.keyCode&&(t.preventDefault(),e(t.currentTarget).siblings(".button").trigger("click"))},insert_zones:function(s){for(i in s)t.inject(s[i].position,e(['<div class="stub zone pinned" data-position="'+i+'">','<a href="#" title="Remove this zone" class="remove stub-action dashicons dashicons-no"></a>','<input type="text" class="zone-header" value="'+s[i].title.replace(/\"/g,"&quot;")+'">',"</div>"].join("")));e(document).trigger("sm/zone_update")},remove_zones:function(){t.$stream.find(".zone").remove()}},t.init(),t.layouts.init(),window.stream=t});